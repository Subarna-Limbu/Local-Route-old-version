{% extends 'base.html' %}
{% load static %}

{% block title %}Driver Dashboard - Smart Transport{% endblock %}

{% block extra_head %}
<style>
    /* Driver Dashboard Styles */
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .dashboard-header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .welcome-section {
        margin-bottom: 20px;
    }

    .welcome-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--secondary);
        margin-bottom: 10px;
    }

    .driver-info {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-label {
        font-weight: 600;
        color: #6b7280;
    }

    .info-value {
        color: var(--dark);
        font-weight: 600;
    }

    .dashboard-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--secondary);
        margin-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 10px;
    }

    .tracking-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
    }

    .tracking-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .start-tracking {
        background-color: #10b981;
        color: white;
    }

    .start-tracking:hover:not(:disabled) {
        background-color: #059669;
        transform: translateY(-2px);
    }

    .stop-tracking {
        background-color: #ef4444;
        color: white;
    }

    .stop-tracking:hover:not(:disabled) {
        background-color: #dc2626;
        transform: translateY(-2px);
    }

    .tracking-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .tracking-status {
        padding: 15px;
        background-color: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
        margin: 15px 0;
        font-weight: 600;
    }

    /* Seat Grid Styles */
    .seat-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: 80px 40px 40px 40px 40px 40px;
        grid-auto-rows: 48px;
        max-width: 400px;
        margin: 20px 0;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
    }

    .seat-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .seat-available {
        background-color: #10b981;
    }

    .seat-occupied {
        background-color: #ef4444;
    }

    .seat-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .seat-info {
        color: #6b7280;
        font-size: 0.9rem;
        margin-top: 10px;
    }

    /* Notifications Styles */
    .notifications-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .notifications-header {
        background: var(--secondary);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notifications-badge {
        background: #ef4444;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
    }

    .clear-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.3s;
    }

    .clear-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .notifications-list {
        height: 150px;
        overflow-y: auto;
        padding: 15px;
        background: #fafafa;
    }

    .notification-item {
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border-radius: 6px;
        border-left: 4px solid var(--accent);
        cursor: pointer;
        transition: background 0.3s;
    }

    .notification-item:hover {
        background: #f3f4f6;
    }

    .notification-item.selected {
        background: #e0f2fe;
        border-left-color: var(--primary);
    }

    /* Chat Styles */
    .chat-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .chat-header {
        background: var(--secondary);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-log {
        height: 200px;
        overflow-y: auto;
        padding: 15px;
        background: #fafafa;
        border-bottom: 1px solid #e5e7eb;
    }

    .chat-message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 8px;
        max-width: 80%;
    }

    .message-driver {
        background: var(--primary);
        color: white;
        margin-left: auto;
    }

    .message-user {
        background: white;
        border: 1px solid #e5e7eb;
        margin-right: auto;
    }

    .chat-input-container {
        display: flex;
        padding: 15px;
        gap: 10px;
        background: white;
    }

    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
    }

    .send-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
    }

    .send-btn:hover {
        background: var(--secondary);
    }

    /* Bus Creation Form */
    .bus-creation-form {
        background: #f8fafc;
        padding: 25px;
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        max-width: 300px;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
    }

    .form-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
    }

    .create-bus-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .create-bus-btn:hover {
        background: var(--secondary);
        transform: translateY(-2px);
    }

    .pending-verification {
        background: #fef3c7;
        border: 2px solid #f59e0b;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
    }

    .pending-verification h3 {
        font-size: 1.5rem;
        color: #92400e;
        margin-bottom: 10px;
    }

    .no-route-assigned {
        background: #fee2e2;
        border: 2px solid #ef4444;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
    }

    .no-route-assigned h3 {
        font-size: 1.5rem;
        color: #991b1b;
        margin-bottom: 10px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 10px;
        }

        .dashboard-header {
            padding: 20px;
        }

        .welcome-title {
            font-size: 1.5rem;
        }

        .driver-info {
            flex-direction: column;
            gap: 15px;
        }

        .tracking-controls {
            flex-direction: column;
        }

        .tracking-btn {
            width: 100%;
            justify-content: center;
        }

        .seat-grid {
            max-width: 100%;
        }

        .chat-input-container {
            flex-direction: column;
        }

        .send-btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1 class="welcome-title">üöó Driver Dashboard</h1>
            <p style="color: #6b7280;">Welcome back, <strong>{{ request.user.username }}</strong>!</p>
        </div>
        <div class="driver-info">
            <div class="info-item">
                <span class="info-label">Vehicle Number:</span>
                <span class="info-value">{{ driver.vehicle_number }}</span>
            </div>
            {% if bus %}
                <div class="info-item">
                    <span class="info-label">Bus ID:</span>
                    <span class="info-value" id="busIdDisplay">{{ bus.id }}</span>
                </div>
            {% endif %}
        </div>
    </div>

    {% if driver.verified %}
        {% if route and bus %}
        <div class="dashboard-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6;">
            <h2 class="section-title" style="border: none; padding-bottom: 0; margin-bottom: 15px;">
                üîÑ Route Management
            </h2>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--secondary); margin-bottom: 8px;">
                        üìç Current Route: {{ route.name }}
                    </div>
                    <div style="font-size: 0.95rem; color: #6b7280; margin-bottom: 4px;">
                        üöè {{ route.get_stops_list|length }} stops
                    </div>
                    {% if route.reverse_route %}
                        <div style="font-size: 0.9rem; color: #3b82f6; font-weight: 600;">
                            ‚ÜîÔ∏è Reverse available: {{ route.reverse_route.name }}
                        </div>
                    {% endif %}
                </div>
                <div>
                    {% if route.reverse_route %}
                        <button id="switchRouteBtn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            üîÑ Switch to {{ route.reverse_route.name }}
                        </button>
                    {% else %}
                        <button style="background: #9ca3af; color: white; border: none; padding: 14px 28px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: not-allowed;" disabled>
                            üö´ No Reverse Route
                        </button>
                    {% endif %}
                </div>
            </div>
            
            {% if route.reverse_route %}
                <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #10b981;">
                    <p style="margin: 0; color: #059669; font-size: 0.9rem;">
                        <strong>üí° Pro Tip:</strong> After completing your route to the destination, 
                        click "Switch Route" to start the return journey.
                    </p>
                </div>
            {% endif %}
        </div>
            <!-- Tracking Section -->
            <div class="dashboard-section">
                <h2 class="section-title">üìç Live Location Tracking</h2>
                <div class="tracking-controls">
                    <button id="startTracking" class="tracking-btn start-tracking">
                        ‚ñ∂Ô∏è Start Tracking
                    </button>
                    <button id="stopTracking" class="tracking-btn stop-tracking" disabled>
                        ‚èπÔ∏è Stop Tracking
                    </button>
                </div>
                <div id="trackingStatus" class="tracking-status" style="display: none;"></div>
            </div>

            <!-- Seat Management Section -->
            <div class="dashboard-section">
                <h2 class="section-title">üí∫ Seat Arrangement ({{ bus.total_seats }} seats)</h2>
                <div class="seat-grid">
                    {% for seat, row, col in seat_grid_columns %}
                        <button class="seat-btn {% if seat.is_available %}seat-available{% else %}seat-occupied{% endif %}" 
                            data-seat-id="{{ seat.id }}" 
                            style="grid-column: {{ col }}; grid-row: {{ row }};">
                            {{ seat.seat_number }}
                        </button>
                    {% endfor %}
                </div>
                <div class="seat-info">
                    üü¢ Click a seat to toggle availability | Green = Available | Red = Occupied
                </div>
                            <!-- Upcoming Stops Section -->
{% if route and bus %}
<div class="upcoming-stops-section">
    <h2 class="section-title">üìç Upcoming Stops with Pickup Requests</h2>
    <div id="upcomingStopsContainer">
        <div style="text-align: center; color: #9ca3af; padding: 20px;">
            Loading stops...
        </div>
    </div>
</div>
{% endif %}
</div>

<style>
 /* ‚≠ê UPCOMING STOPS STYLES */

.upcoming-stops-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.stop-card {
    background: white;
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #10b981;
    transition: all 0.3s ease;
    position: relative;
}

.stop-card:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stop-card.next-stop {
    border-left-color: #ef4444;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.stop-card.next-stop .stop-header {
    color: #991b1b;
}

.stop-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.stop-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: #065f46;
    display: flex;
    align-items: center;
    gap: 8px;
}

.stop-number {
    background: #10b981;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 700;
}

.next-stop .stop-number {
    background: #ef4444;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.passenger-count {
    background: #3b82f6;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
}

.passengers-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.passenger-item {
    background: #f9fafb;
    padding: 10px 12px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e5e7eb;
}

.passenger-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.passenger-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
}

.passenger-details {
    display: flex;
    flex-direction: column;
}

.passenger-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.95rem;
}

.passenger-time {
    font-size: 0.75rem;
    color: #6b7280;
}

.passenger-message {
    font-size: 0.85rem;
    color: #4b5563;
    margin-top: 4px;
    font-style: italic;
}

.reserve-btn {
    background: #10b981;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.reserve-btn:hover {
    background: #059669;
    transform: translateY(-2px);
}

.reserve-btn.reserved {
    background: #6b7280;
    cursor: default;
}

.no-requests {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
}

.no-requests i {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.3;
}
.reserve-seat-btn {
    background: #10b981;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.reserve-seat-btn:hover:not(:disabled) {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
}

.reserve-seat-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    opacity: 0.6;
}

.notification-item {
    transition: background 0.2s ease;
} 
</style>
{% comment %} <style>
.pickup-request-card {
    background: white;
    border-left: 4px solid #f59e0b;
    padding: 12px;
    margin-top: 10px;
    border-radius: 6px;
}

.passenger-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.passenger-name {
    font-weight: 600;
    color: var(--dark);
    font-size: 0.95rem;
}

.request-time {
    font-size: 0.8rem;
    color: #6b7280;
}

.request-message {
    font-size: 0.85rem;
    color: #374151;
    margin: 6px 0;
    padding: 6px;
    background: #f3f4f6;
    border-radius: 4px;
}

.reserve-action-btn {
    background: #10b981;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 8px;
}

.reserve-action-btn:hover:not(:disabled) {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
}

.reserve-action-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.seat-reserved-badge {
    background: #10b981;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 600;
    text-align: center;
    margin-top: 8px;
}
</style> {% endcomment %}

            </div>

            <!-- Notifications Section -->
            <div class="dashboard-section">
                <h2 class="section-title">üîî Pickup Notifications</h2>
                <div class="notifications-container">
                    <div class="notifications-header">
                        <div>
                            <strong>Notifications</strong>
                            <span id="notifBadge" class="notifications-badge" style="display: none;">0</span>
                        </div>
                        <button id="clearAllNotifs" class="clear-btn">Clear All</button>
                    </div>
                    <div id="driverNotifications" class="notifications-list">
                        <div style="text-align: center; color: #9ca3af; padding: 20px;">
                            No notifications yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="dashboard-section">
                <h2 class="section-title">üí¨ Chat with Passengers</h2>
                <div class="chat-container">
                    <div class="chat-header">
                        <strong>Conversation</strong>
                        <button id="clearDriverChat" class="clear-btn">Clear Chat</button>
                    </div>
                    <div id="driverChatLog" class="chat-log">
                        <div style="text-align: center; color: #9ca3af; padding: 20px;">
                            Select a notification to start chatting
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input id="driverChatInput" class="chat-input" placeholder="Type your message..." />
                        <button id="driverSendChat" class="send-btn">Send</button>
                    </div>
                </div>
            </div>

        {% elif route and not bus %}
            <!-- Bus Creation Form -->
            <div class="dashboard-section">
                <h2 class="section-title">üöå Create Your Bus</h2>
                <div class="bus-creation-form">
                    <p style="margin-bottom: 20px; color: #6b7280;">
                        You need to create a bus to start operating. Please fill in the details below:
                    </p>
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="form-label">Total Seats *</label>
                            <input type="number" name="total_seats" min="10" max="60" value="25" 
                                   class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bus Number Plate *</label>
                            <input type="text" name="number_plate" class="form-input" 
                                   placeholder="e.g., BA 1 PA 8271" required>
                        </div>
                        <button type="submit" class="create-bus-btn">
                            ‚úì Create Bus
                        </button>
                    </form>
                </div>
            </div>
        {% else %}
            <!-- No Route Assigned -->
            <div class="no-route-assigned">
                <h3>‚ö†Ô∏è No Route Assigned</h3>
                <p>Please contact the administrator to assign a route to your account.</p>
            </div>
        {% endif %}
    {% else %}
        <!-- Pending Verification -->
        <div class="pending-verification">
            <h3>‚è≥ Verification Pending</h3>
            <p>Your driver account is pending admin verification. You will be notified once approved.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>


{% if route and bus %}
// ==================== LOCATION TRACKING SYSTEM (FIXED VERSION) ====================
let socket;
let geoWatchId = null;
let lastSentLocation = null;
const busId = "{{ bus.id }}";
const startBtn = document.getElementById('startTracking');
const stopBtn = document.getElementById('stopTracking');
const status = document.getElementById('trackingStatus');

// Minimum distance (meters) before sending update
const MIN_DISTANCE_CHANGE = 10;

// Calculate distance between two coordinates
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth radius in meters
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// Start tracking button
startBtn.addEventListener('click', function() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        console.log('WebSocket already open');
        return;
    }
    
    if (!navigator.geolocation) {
        status.style.display = 'block';
        status.className = 'tracking-status';
        status.style.backgroundColor = '#fee2e2';
        status.style.color = '#991b1b';
        status.innerHTML = '‚ùå Geolocation not supported by your browser.';
        return;
    }
    
    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + 
                  window.location.host + '/ws/location/' + busId + '/';
    
    console.log('Connecting to WebSocket:', wsUrl);
    socket = new WebSocket(wsUrl);
    
    socket.onopen = function() {
        console.log('‚úÖ WebSocket connected');
        status.style.display = 'block';
        status.innerHTML = '‚úÖ Tracking started successfully!';
        startBtn.disabled = true;
        stopBtn.disabled = false;
        
        lastSentLocation = null;
        
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        };
        
        console.log('Starting geolocation watch...');
        
        // ‚≠ê FIXED: Use continuous watchPosition WITHOUT interval
        geoWatchId = navigator.geolocation.watchPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                console.log('üìç Location:', {
                    lat: lat.toFixed(6),
                    lng: lng.toFixed(6),
                    accuracy: accuracy.toFixed(0) + 'm'
                });
                
                // Ignore poor accuracy readings
                if (accuracy > 100) {
                    console.log(`‚ö†Ô∏è Ignoring low-accuracy GPS: ${accuracy.toFixed(0)}m`);
                    return;
                }
                
                // Check if location changed significantly
                let shouldSend = true;
                if (lastSentLocation) {
                    const distance = calculateDistance(
                        lastSentLocation.lat, lastSentLocation.lng,
                        lat, lng
                    );
                    
                    const timeSinceLastSend = (Date.now() - (lastSentLocation.timestamp || 0)) / 1000;
                    
                    // Send if moved >10m OR 3 seconds passed
                    if (distance < MIN_DISTANCE_CHANGE && timeSinceLastSend < 3) {
                        shouldSend = false;
                        console.log(`‚è≠Ô∏è Skipping (moved only ${distance.toFixed(1)}m, ${timeSinceLastSend.toFixed(1)}s)`);
                    }
                }
                
                if (shouldSend && socket.readyState === WebSocket.OPEN) {
                    const data = {
                        type: 'location',
                        lat: lat,
                        lng: lng
                    };
                    
                    socket.send(JSON.stringify(data));
                    lastSentLocation = { lat: lat, lng: lng, timestamp: Date.now() };
                    console.log('üì§ Location sent to server');
                }
            }, 
            function(error) {
                console.error('‚ùå Geolocation error:', error);
                status.style.backgroundColor = '#fee2e2';
                status.style.color = '#991b1b';
                
                let errorMsg = '‚ùå GPS Error: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg += 'Permission denied. Please enable location access.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg += 'Location unavailable. Check GPS is enabled.';
                        break;
                    case error.TIMEOUT:
                        errorMsg += 'Request timeout. Retrying...';
                        break;
                    default:
                        errorMsg += error.message;
                }
                status.innerHTML = errorMsg;
            }, 
            geoOptions
        );
        
        console.log('‚úÖ Geolocation watch started');
    };
    
    socket.onmessage = function(event) {
        console.log('üì® Server message:', event.data);
    };
    
    socket.onerror = function(error) {
        console.error('‚ùå WebSocket error:', error);
        status.style.backgroundColor = '#fee2e2';
        status.style.color = '#991b1b';
        status.innerHTML = '‚ùå Connection error. Check your internet.';
    };
    
    socket.onclose = function(event) {
        console.log('‚ö†Ô∏è WebSocket closed');
        status.style.backgroundColor = '#fef3c7';
        status.style.color = '#92400e';
        status.innerHTML = '‚ö†Ô∏è Connection closed.';
        startBtn.disabled = false;
        stopBtn.disabled = true;
        
        if (geoWatchId !== null) {
            navigator.geolocation.clearWatch(geoWatchId);
            geoWatchId = null;
            console.log('üõë Geolocation watch stopped');
        }
    };
});

// Stop tracking button
stopBtn.addEventListener('click', function() {
    console.log('üõë Stopping tracking...');
    
    if (socket) {
        socket.close();
        socket = null;
    }
    
    if (geoWatchId !== null) {
        navigator.geolocation.clearWatch(geoWatchId);
        geoWatchId = null;
        console.log('‚úÖ Geolocation watch stopped');
    }
    
    status.style.backgroundColor = '#f3f4f6';
    status.style.color = '#374151';
    status.innerHTML = '‚èπÔ∏è Tracking stopped.';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    
    lastSentLocation = null;
});

// Prevent accidental page close while tracking
window.addEventListener('beforeunload', function(e) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        e.preventDefault();
        e.returnValue = 'Location tracking is active. Are you sure?';
        return e.returnValue;
    }
});

// Prevent accidental page close while tracking
window.addEventListener('beforeunload', function(e) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        e.preventDefault();
        e.returnValue = 'Location tracking is active. Are you sure?';
        return e.returnValue;
    }
});


// Seat toggle functionality
document.querySelectorAll('.seat-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const seatId = this.getAttribute('data-seat-id');
        
        fetch('/api/toggle_seat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ seat_id: seatId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (data.is_available) {
                    this.classList.remove('seat-occupied');
                    this.classList.add('seat-available');
                } else {
                    this.classList.remove('seat-available');
                    this.classList.add('seat-occupied');
                }
            }
        })
        .catch(error => {
            console.error('Error toggling seat:', error);
        });
    });
});
{% endif %}

// Real-time notifications and chat system
{% if request.user.is_authenticated and request.user.driver_profile %}
(function(){
    const driverId = {{ request.user.id }};
    const chatRoom = 'driver_' + driverId;
    const driverSocket = new WebSocket(
        (location.protocol === 'https:' ? 'wss://' : 'ws://') + 
        window.location.host + '/ws/chat/' + chatRoom + '/'
    );

    // Socket connection handlers
    driverSocket.onopen = function(){ 
        console.log('Driver chat socket opened:', chatRoom); 
    };
    
    driverSocket.onerror = function(error){
        console.error('Driver WebSocket error:', error);
    };

    const notifBox = document.getElementById('driverNotifications');
    const notifBadge = document.getElementById('notifBadge');
    const chatLog = document.getElementById('driverChatLog');
    const chatInput = document.getElementById('driverChatInput');
    const sendBtn = document.getElementById('driverSendChat');

    // Notification badge management
    function setBadge(count){
        if (!notifBadge) return;
        if (count && count > 0) {
            notifBadge.innerText = count;
            notifBadge.style.display = 'inline-block';
        } else {
            notifBadge.style.display = 'none';
        }
    }

    // Load initial notifications
    fetch('/driver/notifications/')
        .then(r => r.json())
        .then(data => {
            if (data && typeof data.unread_count !== 'undefined') {
                setBadge(data.unread_count);
            }
            if (data.recent && Array.isArray(data.recent)){
                notifBox.innerHTML = ''; // Clear placeholder
                data.recent.forEach(function(p){
                    addNotification(p);
                });
            }
        })
        .catch(console.error);

    // WebSocket message handler
    driverSocket.onmessage = function(e){
        let data;
        try {
            data = JSON.parse(e.data);
        } catch(err){
            console.error('Driver WS parse error', err, e.data);
            return;
        }

      if (data.type === 'pickup_notification') {
    addNotification(data);
    const current = parseInt(notifBadge.innerText || '0') || 0;
    setBadge(current + 1);
} 
else if (data.type === 'chat_message') {
    addChatMessage(data);
} 
// ‚≠ê ADD THESE NEW CASES:
else if (data.type === 'pickup_request_canceled') {
    console.log('Pickup request canceled:', data.pickup_id);
    
    // Remove from local array
    const index = pickupRequests.findIndex(p => p.id === data.pickup_id);
    if (index !== -1) {
        pickupRequests.splice(index, 1);
        console.log('Removed pickup from array');
    }
    
    // Refresh display
    displayUpcomingStops();
    
    // Show notification
    showNotification('üìç Pickup request canceled', 'success');
}
else if (data.type === 'reservation_canceled') {
    console.log('Reservation canceled:', data);
    
    // Remove from local array
    const index = pickupRequests.findIndex(p => p.id === data.pickup_id);
    if (index !== -1) {
        pickupRequests.splice(index, 1);
        console.log('Removed reservation from array');
    }
    
    // Refresh display and reload
    displayUpcomingStops();
    
    // Show notification
    showNotification('üí∫ Seat reservation canceled', 'success');
}
    };

function addNotification(notification) {
    // Clear placeholder on first notification
    if (notifBox.innerHTML.includes('No notifications')) {
        notifBox.innerHTML = '';
    }
    
    const el = document.createElement('div');
    el.className = 'notification-item';
    
    // ‚≠ê SIMPLIFIED - No reserve button, just for chat history
    el.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
            <div style="flex: 1;">
                <strong>üöè Pickup Request</strong><br>
                From: ${notification.user_username || 'User #' + notification.user_id}<br>
                Stop: ${notification.stop}<br>
                ${notification.message ? '<small style="color: #6b7280;">' + notification.message + '</small><br>' : ''}
                <small>${new Date().toLocaleTimeString()}</small>
                ${notification.reserved_seat_number ? '<br><span style="color: #10b981; font-weight: 600;">‚úÖ Seat ' + notification.reserved_seat_number + ' Reserved</span>' : ''}
            </div>
        </div>
    `;
    
    el.setAttribute('data-user-id', notification.user_id);
    el.setAttribute('data-pickup-id', notification.pickup_id || '');
    
    // Click to load chat
    el.addEventListener('click', function(e) {
        document.querySelectorAll('.notification-item').forEach(item => {
            item.classList.remove('selected');
        });
        this.classList.add('selected');
        
        if (notification.pickup_id) {
            markPickupSeen(notification.pickup_id);
        }
        
        loadChatHistory(notification.user_id);
    });
    
    notifBox.appendChild(el);
    notifBox.scrollTop = notifBox.scrollHeight;
}
    function addChatMessage(message) {
        // Clear placeholder on first message
        if (chatLog.innerHTML.includes('Select a notification')) {
            chatLog.innerHTML = '';
        }
        
        const el = document.createElement('div');
        el.className = `chat-message ${message.sender_id === {{ request.user.id }} ? 'message-driver' : 'message-user'}`;
        el.innerHTML = `
            <strong>${message.sender_name || 'User'}:</strong> ${message.content}<br>
            <small>${new Date().toLocaleTimeString()}</small>
        `;
        chatLog.appendChild(el);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function markPickupSeen(pickupId) {
        fetch('/api/mark_pickup_seen/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'pickup_id=' + encodeURIComponent(pickupId)
        })
        .then(r => r.json())
        .then(data => {
            if (data && data.status === 'ok') {
                const current = parseInt(notifBadge.innerText || '0') || 1;
                setBadge(Math.max(0, current - 1));
            }
        })
        .catch(console.error);
    }

    function loadChatHistory(userId) {
        fetch('/messages/' + userId + '/')
            .then(r => r.json())
            .then(data => {
                if (data && data.status === 'success' && Array.isArray(data.messages)) {
                    chatLog.innerHTML = '';
                    data.messages.forEach(function(m){
                        addChatMessage({
                            sender_id: m.sender === '{{ request.user.username }}' ? {{ request.user.id }} : userId,
                            sender_name: m.sender,
                            content: m.content
                        });
                    });
                }
            })
            .catch(console.error);
    }

    // Send chat message
    sendBtn.addEventListener('click', function(){
        const content = chatInput.value.trim();
        if (!content) return;
        
        const selectedNotification = document.querySelector('.notification-item.selected');
        const recipientId = selectedNotification ? selectedNotification.getAttribute('data-user-id') : null;
        
        if (!recipientId) {
            alert('Please select a passenger from notifications first.');
            return;
        }

        const payload = {
            type: 'chat_message',
            content: content,
            recipient_id: parseInt(recipientId),
            bus_id: {% if bus %}{{ bus.id }}{% else %}null{% endif %}
        };
        
        driverSocket.send(JSON.stringify(payload));
        chatInput.value = '';
    });

    // Clear all notifications
    document.getElementById('clearAllNotifs').addEventListener('click', function(){
        if (!confirm('Clear all pickup notifications?')) return;
        
        fetch('/api/clear_all_pickups/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data && data.status === 'ok') {
                notifBox.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">No notifications yet</div>';
                setBadge(0);
            }
        })
        .catch(console.error);
    });

    // Clear chat
    document.getElementById('clearDriverChat').addEventListener('click', function(){
        const selectedNotification = document.querySelector('.notification-item.selected');
        const recipientId = selectedNotification ? selectedNotification.getAttribute('data-user-id') : null;
        
        if (!recipientId) {
            alert('Please select a conversation first.');
            return;
        }
        
        if (!confirm('Clear all messages with this user?')) return;
        
        fetch('/api/clear_chat/' + recipientId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data && data.status === 'success') {
                chatLog.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">Select a notification to start chatting</div>';
            }
        })
        .catch(console.error);
    });

    // Enter key to send message
    chatInput.addEventListener('keypress', function(e){
        if (e.key === 'Enter') {
            sendBtn.click();
        }
    });

})();
{% endif %}
{% if route and bus and route.reverse_route %}
// ==================== ROUTE SWITCHING ====================
const switchRouteBtn = document.getElementById('switchRouteBtn');

if (switchRouteBtn) {
    switchRouteBtn.addEventListener('click', function() {
        if (this.disabled) return;
        
        const reverseRouteName = '{{ route.reverse_route.name|escapejs }}';
        const confirmMsg = `Are you sure you want to switch to ${reverseRouteName}?\n\nThis will reset location tracking data.`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        // Show loading state
        this.disabled = true;
        this.innerHTML = '‚è≥ Switching...';
        
        // Make API call
        fetch('/api/switch_route/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('‚úÖ Route switched successfully!\n' + data.old_route + ' ‚Üí ' + data.new_route);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('‚ùå ' + (data.error || 'Failed to switch route'));
                this.disabled = false;
                this.innerHTML = 'üîÑ Switch to {{ route.reverse_route.name|escapejs }}';
            }
        })
        .catch(error => {
            console.error('Route switch error:', error);
            alert('‚ùå Network error. Please check your connection.');
            this.disabled = false;
            this.innerHTML = 'üîÑ Switch to {{ route.reverse_route.name|escapejs }}';
        });
    });
}
{% endif %}
{% if route and bus %}

// ==================== ENHANCED UPCOMING STOPS WITH PICKUP REQUESTS ====================

let currentStopIndex = 0;
let pickupRequests = [];

// ‚≠ê NEW: Get current available seats count
function getAvailableSeatsCount() {
    const availableSeats = document.querySelectorAll('.seat-btn.seat-available');
    return availableSeats ? availableSeats.length : 0;
}

// ‚≠ê NEW: Check if request is within 1 hour
function isWithinTimeFrame(timestamp) {
    if (!timestamp) return false;
    
    try {
        const requestTime = new Date(timestamp);
        const now = new Date();
        const hoursDiff = (now - requestTime) / (1000 * 60 * 60);
        
        return hoursDiff <= 1; // Only show requests from last 1 hour
    } catch (e) {
        return false;
    }
}

// Function to organize and display pickup requests by stop
function displayUpcomingStops() {
    const container = document.getElementById('upcomingStopsContainer');
    const availableSeats = getAvailableSeatsCount();
    
    // ‚≠ê Filter requests: within 1 hour only
    const validRequests = pickupRequests.filter(p => isWithinTimeFrame(p.created_at));
    
    if (!validRequests || validRequests.length === 0) {
        container.innerHTML = `
            <div class="no-requests">
                <i class="fas fa-inbox"></i>
                <p>No recent pickup requests</p>
                <small>Requests from last 1 hour will appear here</small>
            </div>
        `;
        return;
    }
    
    // Group requests by stop
    const stopGroups = {};
    
    validRequests.forEach(request => {
        const stopIndex = request.stop_index;
        if (stopIndex === null || stopIndex === undefined) return;
        
        if (!stopGroups[stopIndex]) {
            stopGroups[stopIndex] = {
                stopName: request.stop,
                stopIndex: stopIndex,
                passengers: []
            };
        }
        
        stopGroups[stopIndex].passengers.push(request);
    });
    
    // Sort stops by index (upcoming stops first)
    const sortedStops = Object.values(stopGroups)
        .filter(stop => stop.stopIndex >= currentStopIndex)
        .sort((a, b) => a.stopIndex - b.stopIndex);
    
    if (sortedStops.length === 0) {
        container.innerHTML = `
            <div class="no-requests">
                <i class="fas fa-check-circle"></i>
                <p>No upcoming pickup requests</p>
                <small>All requested stops have been passed</small>
            </div>
        `;
        return;
    }
    
    // ‚≠ê Show available seats warning at top
    let html = '';
    if (availableSeats === 0) {
        html += `
            <div class="alert alert-warning" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                <strong>‚ö†Ô∏è Bus Full:</strong> No available seats. All reserve buttons disabled.
            </div>
        `;
    } else if (availableSeats <= 3) {
        html += `
            <div class="alert alert-info" style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                <strong>‚ÑπÔ∏è Low Seats:</strong> Only ${availableSeats} seat${availableSeats > 1 ? 's' : ''} available.
            </div>
        `;
    }
    
    html += '<div class="upcoming-stops-list">';
    
    sortedStops.forEach((stop, index) => {
        const isNextStop = index === 0;
        
        html += `
            <div class="stop-card ${isNextStop ? 'next-stop' : ''}" data-stop-index="${stop.stopIndex}">
                <div class="stop-header">
                    <div class="stop-name">
                        <span class="stop-number">${stop.stopIndex + 1}</span>
                        ${isNextStop ? 'üî¥' : 'üöè'} ${stop.stopName}
                        ${isNextStop ? '<span style="color: #ef4444; font-size: 0.85rem; margin-left: 8px;">(NEXT STOP)</span>' : ''}
                    </div>
                    <div class="passenger-count">
                        <i class="fas fa-users"></i>
                        ${stop.passengers.length} ${stop.passengers.length === 1 ? 'passenger' : 'passengers'}
                    </div>
                </div>
                
                <div class="passengers-list">
        `;
        
        stop.passengers.forEach(passenger => {
            const initial = passenger.user_username ? passenger.user_username.charAt(0).toUpperCase() : 'U';
            const timeAgo = getTimeAgo(passenger.created_at);
            const isReserved = passenger.seat_reserved || false;
            
            html += `
                <div class="passenger-item" data-pickup-id="${passenger.id}" data-reserved="${isReserved}">
                    <div class="passenger-info">
                        <div class="passenger-avatar">${initial}</div>
                        <div class="passenger-details">
                            <div class="passenger-name">üë§ ${passenger.user_username || 'User #' + passenger.user_id}</div>
                            <div class="passenger-time">‚è∞ ${timeAgo}</div>
                            ${passenger.message ? `<div class="passenger-message">üí¨ "${passenger.message}"</div>` : ''}
                        </div>
                    </div>
            `;
            
            // ‚≠ê Smart button logic
            if (isReserved) {
                html += `
                    <button class="reserve-btn reserved" disabled>
                        ‚úÖ Seat Reserved
                    </button>
                `;
            } else if (availableSeats === 0) {
                html += `
                    <button class="reserve-btn" disabled style="background: #9ca3af; cursor: not-allowed;">
                        üö´ Bus Full
                    </button>
                `;
            } else {
                html += `
                    <button class="reserve-btn" onclick="reserveSeatForPassenger(${passenger.id}, event)">
                        üí∫ Reserve Seat
                    </button>
                `;
            }
            
            html += `
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    container.innerHTML = html;
}

// Helper function to get time ago
function getTimeAgo(timestamp) {
    if (!timestamp) return 'Just now';
    
    try {
        const date = new Date(timestamp);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        return 'Over 1h ago'; // ‚≠ê Changed for clarity
    } catch (e) {
        return 'Recently';
    }
}

 function reserveSeatForPassenger(pickupId, event) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    // Check if seats available
    const availableSeats = document.querySelectorAll('.seat-btn.seat-available');
    if (availableSeats.length === 0) {
        alert('‚ùå No available seats! Bus is full.');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Reserving...';
    
    // ‚≠ê FIXED: Call the correct reserve_seat endpoint
    fetch('/api/reserve_seat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'pickup_id=' + encodeURIComponent(pickupId)
    })
    .then(response => response.json())
.then(data => {
        if (data.status === 'success') {
            // Update button PERMANENTLY
            btn.innerHTML = '‚úÖ Seat ' + data.seat_number;
            btn.classList.add('reserved');
            btn.style.background = '#9ca3af';
            btn.style.cursor = 'not-allowed';
            
            // Mark in local array
            const pickupRequest = pickupRequests.find(p => p.id === pickupId);
            if (pickupRequest) {
                pickupRequest.seat_reserved = true;
                pickupRequest.reserved_seat_number = data.seat_number;
            }
            
            // Just re-render, don't reload from server
            displayUpcomingStops();
            showNotification(`‚úÖ Seat ${data.seat_number} reserved!`, 'success');
        } else {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('‚ùå ' + (data.error || 'Failed'));
        }
    })
    .catch(error => {
        console.error('Error reserving seat:', error);
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('‚ùå Network error. Please try again.');
    });
} 

// ‚≠ê NEW: Show notification toast
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    notification.innerText = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Load initial pickup requests
function loadPickupRequests() {
    fetch('/driver/notifications/')
        .then(r => r.json())
        .then(data => {
            if (data && data.status === 'success') {
                // ‚≠ê FIX: Filter requests - must have stop_id AND stop_index
                pickupRequests = (data.pickups || []).filter(p => {
                    const isValid = p.stop_id && (p.stop_index !== null) && isWithinTimeFrame(p.created_at);
                    if (!isValid) {
                        console.log('Filtering out invalid pickup:', p.id, 'stop_id:', p.stop_id, 'stop_index:', p.stop_index);
                    }
                    return isValid;
                });
                
                console.log('üìã Loaded pickup requests (last 1h):', pickupRequests.length);
                displayUpcomingStops();
            } else {
                console.error('Failed to load pickups:', data);
            }
        })
        .catch(error => {
            console.error('Error loading pickups:', error);
        });
}

// Listen for new pickup notifications via WebSocket
if (typeof driverSocket !== 'undefined' && driverSocket) {
    const originalOnMessage = driverSocket.onmessage;
    
    driverSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        // Handle pickup notifications
        if (data.type === 'pickup_notification') {
            if (data.stop_id && data.stop_index !== null) {
                pickupRequests.push({
                    id: data.pickup_id,
                    user_id: data.user_id,
                    user_username: data.user_username,
                    stop: data.stop,
                    stop_id: data.stop_id,
                    stop_index: data.stop_index,
                    message: data.message,
                    created_at: new Date().toISOString(),
                    seat_reserved: false
                });
                
                displayUpcomingStops();
                showNotification(`üîî New pickup request at ${data.stop}`, 'success');
                console.log('üîî New pickup request at stop:', data.stop);
            }
        }
        
        // Call original handler if exists
        if (originalOnMessage) {
            originalOnMessage.call(this, e);
        }
    };
else if (data.type === 'pickup_request_canceled') {  // ‚≠ê CHANGED NAME
    console.log('Pickup cancelled:', data.pickup_id);
    const index = pickupRequests.findIndex(p => p.id === data.pickup_id);
    if (index !== -1) {
        pickupRequests.splice(index, 1);
    }
    displayUpcomingStops();
    showNotification(`üìç ${data.message || 'Pickup request cancelled'}`, 'success');
}
else if (data.type === 'reservation_canceled') {  // ‚≠ê CHANGED NAME
    console.log('Reservation cancelled:', data);
    const index = pickupRequests.findIndex(p => p.id === data.pickup_id);
    if (index !== -1) {
        pickupRequests.splice(index, 1);
    }
    displayUpcomingStops();
    loadUpcomingStops();
    showNotification(`üí∫ ${data.message || 'Seat reservation cancelled'}`, 'success');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPickupRequests();
    
    // Refresh every 30 seconds and clean old requests
    setInterval(() => {
        loadPickupRequests();
    }, 30000);
});

{% endif %}
</script>
{% endblock %}
